# 리팩토링 실습

강의를 다 듣고 마지막 챌린지를 수행한 내용 정리해보았습니다.

## 목차
1. 코드이해 (공연에 대한 송장내역 출력함수)
2. 함수분리 (하나의 동작에 대한 하나의 함수 생성)
3. 각 함수에 대한 책임을 맡을 클래스 생성 (비용 계산을 담는 bill, 영수내용을 출력 할 invoice)
4. 위임자로 다형성 이용
5. 추상화로 공통작업 처리
6. 새 기능 추가 (그냥 문자열 말고 html로 출력하도록)
7. 더 해볼만한 것

# 1. 코드 이해
statement는 공연 정보와, 송장내용을 받아 공연에 대한 결제비용을 출력하는 함수입니다.


각 공연을 순회하면서 공연종류에 따라 비용과, 포인트를 계산하고
전체 결제 내역에대한 정보를 출력합니다. 여러 동작이 혼재되어있어 이해가 힘듭니다. 그래서 이 함수를 리팩토링하려고 합니다.

# 2. 잘게 쪼개기
일단 하나의 동작마다 함수로 분리시켜봅시다. 이대로는 어떻게 해야할지 잘 모르겠습니다.

* 데이터 분리
* 공연 별 가격 계산, 포인트 적립, 청구내역 출력 등의 동작을 함수로 분리합니다.

# 3. 클래스 생성

## bill
하나의 청구 내역을 담당할 bill이라는 클래스를 만들고, 가격계산, 포인트 적립,
청구내역 출력함수를 여기로 이동 시킵니다.

## invoice
여러 bill들을 가지고 전체 송장 정보를 다루는 invoice라는 클래스를 만들고, 
bill을 인스턴스로 가지도록 합니다. 그리고 각 bill을 보고, 전체 비용과, 전체 포인트를 계산하여
전체 청구내역을 출력하는 statement라는 매소드를 생성하였습니다.

# 4. 위임자로 다형성을 이용해보자
PerformanceBill을 보면 가격계산과 포인트계산할때 type로 분기하여 각 항목을 계산하고 있습니다.
상속으로 풀 수도 있지만 책에서는 상속을 하면 딱 그 조건으로 밖에 만들수가 없기 때문에 유연성이 떨어지게된다고 합니다.
이게 어떤 영향을 주게되냐면 비극청구내역, 희극청구내역이 있는데 비극이면서 대규모 청구내역인 객체를 만들려먼
다시 비극 청구내역과 비슷한데 조금만 다른 그런 서브클래스를 생성해야하는 문제가 있습니다. 그래서 위임을 통해
그 조금 다른 부분만을 맡게되는 위임자를 만들고 이를 맴버로 가지고 여기다 그 동작을 위임시켜 좀더 유연한 구조를
가져 갈 수 있도록 하였습니다.


위임자가 포인트와 가격계산을 맡도록 리팩토링을 해보겠습니다.
1. invoice 클래스에 팩토리 함수를 만들고,
2. invoice 객체를 생성하는 곳을 모두 이 팩토리 함수로 변경합니다.
3. PerformancePricingDelegate 클래스를 생성하고 포인트 계산과 가격계산 매소드를 여기로 옮깁시다.
4. 공연 타입마다 위임자를 만들고 생성자에서 공연타입을보고 적절한 위임자를 생성하도록 변경합니다.

# 5. 슈퍼클래스를 통해 공통동작에 대한 중복을 제거하자
비극과 희극 가격계산 위임자는 비슷한 동작이 많기 때문에 PerformancePricingDelegate 슈퍼클래스로 추상화하고
다른 동작만 오버라이드해서 중복을 제거해봅시다. 

1. _calcCost <- 자식에서 구현
2. _calcCredits <- 공통동작을 묶고 super.calcCredits을 활용

# 6. HTML로 청구내용을 출력하는 기능을 만들어보자

1. 실패하는 테스트 작성
2. bill과 invoice에 printHTMLDetails 매소드를 만들고 이를 통해 출력하게 함
3. 테스트 한다.

# 7. 더 해볼만한 것
한가지 아쉬운것은 statement가 데이터를 그대로 받아 사용하기 때문에, 데이터 포맷에 의존적입니다.
그래서 play와 performance의 repository를 만들어서
bill과 invoice에서 필요한 정보만 쏙쏙 골라받아 사용하는 그런방식으로 하면 어떨까 생각해보았는데 
너무 간 것 같아서 일단 두었고, 이것은 숙제로 남기도록 하겠습니다.
